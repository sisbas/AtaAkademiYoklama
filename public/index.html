<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ata Akademi - Yoklama Sistemi</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-left h1 {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .header-left p {
      opacity: 0.9;
    }

    .header-nav {
      display: flex;
      gap: 10px;
    }

    .nav-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: white;
      color: #667eea;
    }

    .controls {
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: end;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .header-nav {
        justify-content: center;
      }
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }

    select, input[type="date"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    select:focus, input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .content {
      padding: 30px;
    }

    #notificationArea {
      display: none;
      margin-bottom: 20px;
      gap: 12px;
    }

    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      border-radius: 6px;
      color: #0c5460;
      line-height: 1.5;
    }

    .info-box.warning {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }

    .info-box.error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }

    .info-box ul {
      margin-top: 10px;
      padding-left: 20px;
    }

    .info-box li {
      margin-bottom: 4px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card .number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .label {
      opacity: 0.9;
      font-size: 0.9em;
    }

    .attendance-list {
      display: grid;
      gap: 10px;
    }

    .student-row {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .student-row:hover {
      border-color: #667eea;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }

    .student-name {
      flex: 1;
      font-weight: 600;
      color: #212529;
    }

    .status-select {
      padding: 8px 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 150px;
    }

    .status-select:focus {
      outline: none;
      border-color: #667eea;
    }

    .status-select.geldi {
      background-color: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .status-select.gelmedi {
      background-color: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .status-select.mazeretli {
      background-color: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .status-select.izinli {
      background-color: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
      }

      .form-group {
        width: 100%;
      }

      .student-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .status-select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üéì Ata Akademi</h1>
        <p>Yoklama Takip Sistemi</p>
      </div>
      <div class="header-nav">
        <a href="index.html" class="nav-btn active">üìù Yoklama</a>
        <a href="raporlar.html" class="nav-btn">üìä Raporlar</a>
      </div>
    </div>

    <div class="controls">
      <div class="form-group">
        <label for="classSelect">Sƒ±nƒ±f Se√ßin</label>
        <select id="classSelect">
          <option value="">Sƒ±nƒ±f se√ßin...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="dateInput">Tarih</label>
        <input type="date" id="dateInput" />
      </div>

      <button class="btn btn-primary" id="loadButton">Yoklamayƒ± Getir</button>
    </div>

    <div class="content">
      <div id="notificationArea"></div>
      <div id="statsContainer" style="display: none;"></div>
      <div id="attendanceList"></div>
    </div>
  </div>

  <script>
    const REMOTE_API_BASE = 'https://ataakademiyoklama-eb98f60a1c26.herokuapp.com/api';
    const LOCAL_API_BASE = 'http://localhost:3000/api';

    function resolveApiBase() {
      const params = new URLSearchParams(window.location.search);
      const overrideParam = params.get('apiBase');
      if (overrideParam) {
        try {
          window.localStorage?.setItem('apiBaseOverride', overrideParam);
        } catch (error) {
          console.warn('API taban adresi kaydedilemedi:', error);
        }
      }

      const storedOverride = overrideParam || window.localStorage?.getItem('apiBaseOverride');
      if (storedOverride) {
        return storedOverride.replace(/\/$/, '');
      }

      const host = window.location.hostname;

      if (host === 'localhost' || host === '127.0.0.1') {
        return LOCAL_API_BASE;
      }

      if (host && host.endsWith('herokuapp.com')) {
        return `${window.location.origin.replace(/\/$/, '')}/api`;
      }

      return REMOTE_API_BASE;
    }

    const API_BASE = resolveApiBase();
    const VALID_STATUSES = ['geldi', 'gelmedi', 'mazeretli', 'izinli'];

    const defaultClassList = [
      'TYT Sƒ±nƒ±fƒ±', '9. Sƒ±nƒ±f', '10. Sƒ±nƒ±f',
      '11 Say 1', '11 Say 2', '11 Ea 1', '11 Ea 2',
      '12 Say 1', '12 Say 2', '12 Say 3', '12 Ea 1', '12 Ea 2', '12 Ea 3',
      'Mezun Ea 1', 'Mezun Ea 2', 'Mezun Ea 3',
      'Mezun Say 1', 'Mezun Say 2', 'Mezun Say 3'
    ];

    const classSelect = document.getElementById('classSelect');
    const dateInput = document.getElementById('dateInput');
    const attendanceList = document.getElementById('attendanceList');
    const statsContainer = document.getElementById('statsContainer');
    const notificationArea = document.getElementById('notificationArea');
    const loadButton = document.getElementById('loadButton');

    let classCatalog = [];
    let currentStudents = [];
    let currentMetadata = null;
    let scheduleNotification = null;
    let attendanceNotification = null;
    let connectionNotification = null;

    init();

    async function init() {
      setToday();
      updateConnectionNotification();
      await loadClassCatalog();
      loadButton.addEventListener('click', loadAttendance);
      classSelect.addEventListener('change', updateScheduleNotification);
    }

    function updateConnectionNotification() {
      connectionNotification = {
        type: 'info',
        message: `Sunucu baƒülantƒ±sƒ±: <strong>${API_BASE}</strong>`
      };
      renderNotifications();
    }

    function setToday() {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
    }

    async function loadClassCatalog() {
      try {
        const res = await fetch(`${API_BASE}/classes`);
        if (!res.ok) {
          throw new Error('Sƒ±nƒ±f listesi alƒ±namadƒ±');
        }

        classCatalog = await res.json();
      } catch (error) {
        console.warn('Sƒ±nƒ±f bilgileri y√ºklenemedi, varsayƒ±lan liste kullanƒ±lƒ±yor.', error);
        classCatalog = defaultClassList.map(name => ({ name, schedule: null, notes: 'Ders programƒ± yakƒ±nda g√ºncellenecek.' }));
      }

      populateClassSelect();
    }

    function populateClassSelect() {
      classSelect.innerHTML = '<option value="">Sƒ±nƒ±f se√ßin...</option>';
      classCatalog
        .map(cls => cls.name)
        .concat(defaultClassList)
        .filter((value, index, array) => array.indexOf(value) === index)
        .forEach(cls => {
          const opt = document.createElement('option');
          opt.value = cls;
          opt.textContent = cls;
          classSelect.appendChild(opt);
        });
    }

    async function loadAttendance() {
      const cls = classSelect.value;
      const date = dateInput.value;

      if (!cls || !date) {
        showMessage('L√ºtfen sƒ±nƒ±f ve tarih se√ßin.', 'warning');
        return;
      }

      showLoading();
      attendanceNotification = null;
      renderNotifications();

      try {
        const res = await fetch(`${API_BASE}/attendance?class=${encodeURIComponent(cls)}&date=${date}`);
        const data = await res.json();

        if (!res.ok) {
          showMessage(data.error || 'Hata olu≈ütu.', 'error');
          return;
        }

        currentStudents = data.students || [];
        currentMetadata = data.metadata || { className: cls, date, total: currentStudents.length };

        if (data.classInfo) {
          upsertClassInfo(data.classInfo);
        }

        updateScheduleNotification();
        updateAttendanceNotification();

        if (currentStudents.length === 0) {
          showEmptyState();
          return;
        }

        displayAttendance(currentStudents, currentMetadata);
        displayStats(currentStudents);
      } catch (error) {
        showMessage('Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
      }
    }

    function upsertClassInfo(info) {
      const index = classCatalog.findIndex(cls => cls.name === info.name);
      if (index >= 0) {
        classCatalog[index] = info;
      } else {
        classCatalog.push(info);
      }
    }

    function displayAttendance(students, metadata) {
      let html = `
        <div class="info-box">
          <strong>${metadata.className}</strong> - ${formatDate(metadata.date)}
          <span style="float: right;">${metadata.total || students.length} √ñƒürenci</span>
        </div>
        <div class="attendance-list">
      `;

      students.forEach(student => {
        const originalStatus = student.status || '';
        html += `
          <div class="student-row">
            <span class="student-name">${student.name}</span>
            <select class="status-select ${student.status}"
                    data-id="${student.id}"
                    data-original="${originalStatus}"
                    onchange="saveStatus(this, '${metadata.date}')">
              <option value="">Durum Se√ßin...</option>
              <option value="geldi" ${student.status === 'geldi' ? 'selected' : ''}>‚úì Geldi</option>
              <option value="gelmedi" ${student.status === 'gelmedi' ? 'selected' : ''}>‚úó Gelmedi</option>
              <option value="mazeretli" ${student.status === 'mazeretli' ? 'selected' : ''}>‚ö† Mazeretli</option>
              <option value="izinli" ${student.status === 'izinli' ? 'selected' : ''}>üìù ƒ∞zinli</option>
            </select>
          </div>
        `;
      });

      html += '</div>';
      attendanceList.innerHTML = html;
    }

    function displayStats(students) {
      const stats = {
        geldi: students.filter(s => s.status === 'geldi').length,
        gelmedi: students.filter(s => s.status === 'gelmedi').length,
        mazeretli: students.filter(s => s.status === 'mazeretli').length,
        izinli: students.filter(s => s.status === 'izinli').length,
        total: students.length
      };

      const recorded = stats.geldi + stats.gelmedi + stats.mazeretli + stats.izinli;

      statsContainer.innerHTML = `
        <div class="stats">
          <div class="stat-card">
            <div class="number">${stats.geldi}</div>
            <div class="label">Geldi</div>
          </div>
          <div class="stat-card">
            <div class="number">${stats.gelmedi}</div>
            <div class="label">Gelmedi</div>
          </div>
          <div class="stat-card">
            <div class="number">${stats.mazeretli}</div>
            <div class="label">Mazeretli</div>
          </div>
          <div class="stat-card">
            <div class="number">${stats.izinli}</div>
            <div class="label">ƒ∞zinli</div>
          </div>
        </div>
      `;

      statsContainer.style.display = recorded > 0 ? 'block' : 'none';
    }

    async function saveStatus(select, date) {
      const studentId = select.dataset.id;
      const status = select.value;

      if (!status) {
        select.className = 'status-select';
        return;
      }

      const originalValue = select.dataset.original ?? select.value ?? '';
      select.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId, date, status })
        });

        const result = await res.json();

        if (!res.ok || !result.success) {
          throw new Error(result.error || result.message || 'Kayƒ±t ba≈üarƒ±sƒ±z.');
        }

        select.className = `status-select ${status}`;
        select.dataset.original = status;

        const student = currentStudents.find(s => `${s.id}` === `${studentId}`);
        if (student) {
          student.status = status;
        }

        refreshMetadata();
        displayStats(currentStudents);
        showToast(result.message || '‚úì Yoklama kaydedildi', 'success');
      } catch (error) {
        showToast('‚úó ' + error.message, 'error');
        select.value = originalValue;
        select.className = `status-select ${originalValue}`;
      } finally {
        select.disabled = false;
      }
    }

    function refreshMetadata() {
      if (!currentMetadata) {
        return;
      }

      const recorded = currentStudents.filter(student => VALID_STATUSES.includes(student.status)).length;
      currentMetadata.recorded = recorded;
      currentMetadata.total = currentStudents.length;
      currentMetadata.hasAttendance = recorded > 0;
      updateAttendanceNotification();
    }

    function showLoading() {
      attendanceList.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Y√ºkleniyor...</p>
        </div>
      `;
      statsContainer.style.display = 'none';
    }

    function showMessage(message, type = 'info') {
      attendanceList.innerHTML = `
        <div class="info-box ${type}">
          ${message}
        </div>
      `;
      statsContainer.style.display = 'none';
      renderNotifications();
    }

    function showEmptyState() {
      attendanceList.innerHTML = `
        <div class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <h3>√ñƒürenci Bulunamadƒ±</h3>
          <p>Bu sƒ±nƒ±fta kayƒ±tlƒ± √∂ƒürenci bulunmamaktadƒ±r.</p>
        </div>
      `;
      statsContainer.style.display = 'none';
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 9999;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function renderNotifications() {
      const notifications = [connectionNotification, scheduleNotification, attendanceNotification].filter(Boolean);
      if (notifications.length === 0) {
        notificationArea.style.display = 'none';
        notificationArea.innerHTML = '';
        return;
      }

      notificationArea.innerHTML = notifications
        .map(item => `<div class="info-box ${item.type || ''}">${item.html || item.message}</div>`)
        .join('');

      notificationArea.style.display = 'grid';
    }

    function updateScheduleNotification() {
      const selectedClass = classSelect.value;
      if (!selectedClass) {
        scheduleNotification = null;
        renderNotifications();
        return;
      }

      const info = classCatalog.find(cls => cls.name === selectedClass);
      if (!info) {
        scheduleNotification = null;
        renderNotifications();
        return;
      }

      if (info.schedule && Object.keys(info.schedule).length > 0) {
        const items = Object.entries(info.schedule)
          .map(([day, count]) => `<li><strong>${day}</strong>: ${count} ders</li>`)
          .join('');

        const totalText = info.weeklyTotal ? `<p><strong>Haftalƒ±k toplam:</strong> ${info.weeklyTotal} ders</p>` : '';

        scheduleNotification = {
          type: 'info',
          html: `
            <strong>${info.name}</strong> sƒ±nƒ±fƒ± ders programƒ±:
            <ul>${items}</ul>
            ${totalText}
            <p>${info.notes || ''}</p>
          `
        };
      } else {
        scheduleNotification = {
          type: 'warning',
          message: info.notes || 'Ders programƒ± yakƒ±nda g√ºncellenecek.'
        };
      }

      renderNotifications();
    }

    function updateAttendanceNotification() {
      if (!currentMetadata || !currentMetadata.hasAttendance) {
        attendanceNotification = null;
        renderNotifications();
        return;
      }

      const recorded = currentMetadata.recorded || 0;
      const total = currentMetadata.total || currentStudents.length;
      const dateText = formatDate(currentMetadata.date);
      attendanceNotification = {
        type: 'warning',
        message: `${dateText} tarihine ait ${recorded}/${total} √∂ƒürencinin yoklama kaydƒ± mevcut. G√ºncelleme yapabilirsiniz.`
      };

      renderNotifications();
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('tr-TR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    window.saveStatus = saveStatus;

    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
